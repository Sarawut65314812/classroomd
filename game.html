<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ</title>
<style>
body { font-family: sans-serif; text-align: center; margin: 10px; overflow: hidden; }
button { font-size: 16px; padding: 5px 10px; margin: 5px; cursor: pointer; }
.image-item { 
  position: absolute; 
  max-width: 120px; 
  max-height: 120px; 
  cursor: grab; 
  user-select: none; 
  touch-action: none; 
  transition: transform 0.1s;
  border-radius: 10px;
  background: transparent;
  filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
}
.image-item img {
  max-width: 100%;
  max-height: 100%;
  width: auto;
  height: auto;
  object-fit: contain;
  pointer-events: none;
  display: block;
}
.particle { 
  position: absolute; 
  font-size: 16px; 
  opacity: 1; 
  pointer-events: none; 
  animation: fadeOut 0.6s ease-out forwards; 
}
@keyframes fadeOut { 
  to { transform: translateY(-20px) scale(0.5); opacity: 0; } 
}
#zones { 
  display: flex; 
  justify-content: space-around; 
  margin-top: 20px; 
}
.zone { 
  width: 40%; 
  height: 150px; 
  border: 2px dashed #333; 
  border-radius: 10px; 
  line-height: 150px; 
  font-size: 20px; 
  color: #333; 
}

/* Popup */
#scorePopup {
  display:none;
  position:fixed;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  background:#fff;
  border:2px solid #333;
  padding:30px;
  font-size:24px;
  z-index:999;
  border-radius:10px;
  box-shadow:0 0 15px rgba(0,0,0,0.5);
}
#scorePopup button { font-size: 18px; padding: 6px 12px; margin-top: 10px; cursor: pointer; }
</style>
</head>
<body>

<h2>‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠: <span id="topicName"></span></h2>
<button onclick="goToTeacher()">‚öôÔ∏è Teacher Setup</button>

<div id="zones">
  <div id="correctZone" class="zone">Correct ‚úÖ</div>
  <div id="wrongZone" class="zone">Wrong ‚ùå</div>
</div>
<p>Score: <span id="score">0</span></p>

<!-- Popup -->
<div id="scorePopup">
  <p>üéâ Your Score: <span id="finalScore"></span> üéâ</p>
  <button onclick="closePopup()">Close</button>
</div>

<script>
let audioCtx, baseFreq = 200;
const sparkleChars = ['‚ú®', 'üåü', 'üí´', '‚≠ê'];
let createdImages = {};
let score = 0;

// ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å localStorage
let teacherConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
document.getElementById('topicName').innerText = teacherConfig.topic || 'Unknown';

// ‡∏õ‡∏∏‡πà‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π
function goToTeacher(){
  window.location.href = 'teacher.html';
}

// particle effect
function createParticle(x, y) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
  p.style.left = `${x}px`;
  p.style.top = `${y}px`;
  p.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

// ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏•‡∏≤‡∏Å
function initAudio() {
  if (!audioCtx) {
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const s = audioCtx.createBufferSource();
    s.connect(audioCtx.destination);
    s.start();
  }
}

function playSlideTone(freqStart, freqEnd) {
  if (!audioCtx) return;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = 'sine';
  osc.frequency.setValueAtTime(freqStart, audioCtx.currentTime);
  osc.frequency.linearRampToValueAtTime(freqEnd, audioCtx.currentTime + 0.15);
  gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.2);
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
function createDraggableImage(imgData, imageId, isCorrect) {
  if (createdImages[imageId]) return;

  const imageDiv = document.createElement('div');
  imageDiv.classList.add('image-item');
  imageDiv.innerHTML = `<img src="${imgData}" alt="Image">`;

  const startX = 50 + Math.random() * (window.innerWidth - 200);
  const startY = 50 + Math.random() * (window.innerHeight - 350);
  const angle = Math.floor(Math.random() * 360);
  const scale = 0.8 + Math.random() * 0.6;
  
  imageDiv.style.left = `${startX}px`;
  imageDiv.style.top = `${startY}px`;
  imageDiv.style.transform = `rotate(${angle}deg) scale(${scale})`;

  let offsetX, offsetY;
  
  function dragMove(posX, posY) {
    imageDiv.style.left = `${posX}px`;
    imageDiv.style.top = `${posY}px`;
    createParticle(posX + 50, posY + 50);
    playSlideTone(baseFreq, baseFreq + 400);
    baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50;
  }

  // Desktop
  imageDiv.addEventListener('mousedown', e => {
    initAudio();
    e.preventDefault();
    offsetX = e.clientX - imageDiv.offsetLeft;
    offsetY = e.clientY - imageDiv.offsetTop;
    
    function onMove(e) {
      dragMove(e.clientX - offsetX, e.clientY - offsetY);
    }
    
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      checkDrop();
    }
    
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Mobile
  imageDiv.addEventListener('touchstart', e => {
    initAudio();
    const t = e.touches[0];
    offsetX = t.clientX - imageDiv.offsetLeft;
    offsetY = t.clientY - imageDiv.offsetTop;
  });
  
  imageDiv.addEventListener('touchmove', e => {
    const t = e.touches[0];
    dragMove(t.clientX - offsetX, t.clientY - offsetY);
  });
  
  imageDiv.addEventListener('touchend', e => {
    checkDrop();
  });

  function checkDrop() {
    const rect = imageDiv.getBoundingClientRect();
    const correctZone = document.getElementById('correctZone').getBoundingClientRect();
    const wrongZone = document.getElementById('wrongZone').getBoundingClientRect();

    if (rect.left + rect.width / 2 > correctZone.left && rect.left + rect.width / 2 < correctZone.right &&
        rect.top + rect.height / 2 > correctZone.top && rect.top + rect.height / 2 < correctZone.bottom) {
      if (isCorrect) {
        score += 1;
      } else {
        score -= 1;
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    } else if (rect.left + rect.width / 2 > wrongZone.left && rect.left + rect.width / 2 < wrongZone.right &&
               rect.top + rect.height / 2 > wrongZone.top && rect.top + rect.height / 2 < wrongZone.bottom) {
      if (!isCorrect) {
        score += 1;
      } else {
        score -= 1;
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    }
  }

  document.body.appendChild(imageDiv);
  createdImages[imageId] = imageDiv;
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏à‡∏ö‡πÄ‡∏Å‡∏°
function checkEndGame() {
  if (Object.keys(createdImages).length === 0) {
    document.getElementById('finalScore').innerText = score;
    document.getElementById('scorePopup').style.display = 'block';
  }
}

function closePopup() {
  document.getElementById('scorePopup').style.display = 'none';
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏°
function startGame() {
  if (!teacherConfig.correctImages || !teacherConfig.wrongImages) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teacher.html';
    return;
  }

  createdImages = {};
  score = 0;
  document.getElementById('score').innerText = score;

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  teacherConfig.correctImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `correct-${index}`, true);
  });

  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
  teacherConfig.wrongImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `wrong-${index}`, false);
  });
}

startGame();
</script>
</body>
</html>
