<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡πÄ‡∏Å‡∏°‡∏ó‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="css/gamepicture.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
</head>
<body>

<h2>‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicName"></span></h2>



<div id="zones" style="display:none;">
  <div id="correctZone" class="zone">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‚úÖ</div>
  <div id="wrongZone" class="zone">‡∏ú‡∏¥‡∏î ‚ùå</div>
</div>
<p id="scoreDisplay" style="display:none;">Score: <span id="score">0</span></p>

<!-- Popup -->
<div id="scorePopup">
  <p style="font-size:20px; font-weight:600; margin-bottom:8px; color:#555;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ: <span id="topicDisplay"></span></p>
  <p style="font-size:24px; font-weight:600; margin-bottom:10px; color:#666;">‡∏ä‡∏∑‡πà‡∏≠: <span id="playerNameDisplay"></span></p>
  <p id="resultMessage" style="font-size:28px; font-weight:700; margin-bottom:15px;"></p>
  <p style="font-size:32px; font-weight:700; margin:20px 0;">üéâ Your Score: <span id="finalScore"></span> üéâ</p>
  
  <div style="display: flex; justify-content: center; gap: 15px; margin: 25px 0;">
    <button onclick="playAgain()" title="‡πÄ‡∏•‡πà‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á" style="background: linear-gradient(135deg, #4CAF50, #45a049); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      üîÑ
    </button>
    <div style="position: relative;">
      <button onclick="toggleShareMenu()" title="‡πÅ‡∏ä‡∏£‡πå/‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å" style="background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
        üîó
      </button>
      <div id="shareMenu" style="display: none; position: absolute; bottom: 85px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, #ffffff 0%, #f5f5f5 100%); border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.4); overflow: hidden; min-width: 180px; z-index: 10000; border: 3px solid #2196F3;">
        <button onclick="shareResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #2196F3, #1E88E5); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #1976D2, #1565C0)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #2196F3, #1E88E5)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üîó</span> ‡πÅ‡∏ä‡∏£‡πå
        </button>
        <button onclick="saveResult(); toggleShareMenu();" style="width: 100%; padding: 18px 20px; border: none; background: linear-gradient(135deg, #FF9800, #F57C00); color: white; cursor: pointer; font-size: 18px; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 12px; transition: all 0.3s; border-top: 2px solid rgba(255,255,255,0.3); text-shadow: 0 1px 2px rgba(0,0,0,0.2);" onmouseover="this.style.background='linear-gradient(135deg, #F57C00, #E65100)'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='linear-gradient(135deg, #FF9800, #F57C00)'; this.style.transform='scale(1)';">
          <span style="font-size: 28px;">üì•</span> ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        </button>
      </div>
    </div>
    <button onclick="closePopup()" title="‡∏õ‡∏¥‡∏î" style="background: linear-gradient(135deg, #f44336, #d32f2f); color: white; border: none; border-radius: 50%; width: 70px; height: 70px; cursor: pointer; font-size: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 8px rgba(0,0,0,0.3); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
      ‚úñ
    </button>
  </div>
</div>

<!-- Added a modal for selecting saved activities -->
<div id="activityModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 9999; align-items: center; justify-content: center;">
  <div style="background: white; padding: 30px; border-radius: 20px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
    <h2 style="margin: 0 0 20px;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h2>
    <div id="activityList"></div>
    <button onclick="closeActivityModal()" style="margin-top: 20px; padding: 10px 20px; background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer;">‡∏õ‡∏¥‡∏î</button>
  </div>
</div>

<script>
let audioCtx, baseFreq = 200;
const sparkleChars = ['‚ú®', 'üåü', 'üí´', '‚≠ê'];
let createdImages = {};
let score = 0;
let gameStarted = false;

// ‡πÇ‡∏´‡∏•‡∏î config ‡∏à‡∏≤‡∏Å localStorage
let teacherConfig = JSON.parse(localStorage.getItem('emojiGameConfig') || '{}');
document.getElementById('topicName').innerText = teacherConfig.topic || 'Unknown';

// ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏Å‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
document.getElementById('zones').style.display = 'flex';
document.getElementById('scoreDisplay').style.display = 'block';
gameStarted = true;


// particle effect
function createParticle(x, y) {
  const p = document.createElement('div');
  p.className = 'particle';
  p.innerText = sparkleChars[Math.floor(Math.random() * sparkleChars.length)];
  p.style.left = `${x}px`;
  p.style.top = `${y}px`;
  p.style.transform = `scale(${Math.random() * 1.5 + 0.5})`;
  document.body.appendChild(p);
  setTimeout(() => p.remove(), 600);
}

// Refine the PDF generation logic to align with demo.html and teacherdemo.html

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏ä‡∏£‡πå‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
async function shareResult() {
  try {
    const date = new Date();
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const percentageScore = Math.min(100, Math.round((score / (teacherConfig.correctImages?.length || 1)) * 100));

    let grade = '';
    if (percentageScore >= 80) {
      grade = '‡∏î‡∏µ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°';
    } else if (percentageScore >= 60) {
      grade = '‡∏î‡∏µ';
    } else if (percentageScore >= 40) {
      grade = '‡∏û‡∏≠‡πÉ‡∏à';
    } else {
      grade = '‡∏ï‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á';
    }

    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    // Updated the PDF content to include the current date and time
    const pdfContent = `
      <div style="font-family: 'Arial', sans-serif; color: #333;">
        <div style="text-align: center; margin-bottom: 12px;">
          <img src='picture/Huaroa.jpg' alt='Logo' style='height: 120px; margin-bottom: 10px; display: block; margin-left: auto; margin-right: auto;' />
        </div>
      <div style="font-family: 'Arial', sans-serif; color: #333;">
        <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h1>
          <p style="margin: 5px 0; font-size: 14px;">Smart Classroom Learning System</p>
          <p style="margin: 5px 0; font-size: 12px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</p>
        </div>
        <div style="background: #f8f9fa; border: 3px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <p style="font-size: 16px; margin: 0 0 15px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 28px; color: #27ae60; font-weight: bold;">${score}/${teacherConfig.correctImages?.length || 0}</p>
        </div>
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="font-size: 14px; font-weight: bold; margin: 0 0 10px 0; color: #667eea;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td>
            </tr>
          </table>
        </div>
        <div style="margin-top: 300px; text-align: center;">
          <p style="margin: 0; font-size: 13px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 5px 0 0 0; font-size: 13px; color: #333;">( _______________________ )</p>
        </div>
      </div>
    `;

    const element = document.createElement('div');
    element.innerHTML = pdfContent;

    html2pdf().set(opt).from(element).output('blob').then(blob => {
      const file = new File([blob], opt.filename, { type: 'application/pdf' });
      if (navigator.canShare && navigator.canShare({ files: [file] })) {
        navigator.share({
          files: [file],
          title: 'Smart Classroom - ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö',
          text: `‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö: ${score}/${teacherConfig.correctImages?.length || 0}`
        }).catch(err => console.log('Error sharing:', err));
      } else {
        html2pdf().set(opt).from(element).save();
      }
    });
  } catch (error) {
    console.error('Error sharing PDF:', error);
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏•‡πÄ‡∏õ‡πá‡∏ô PDF
function saveResult() {
  try {
    const date = new Date();
    // Define dateStr and timeStr within the saveResult function
    const dateStr = date.toLocaleDateString('th-TH');
    const timeStr = date.toLocaleTimeString('th-TH');
    const opt = {
      margin: [12, 12, 12, 12],
      filename: `${teacherConfig.topic || 'score'}_${date.toISOString().split('T')[0]}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    };

    const pdfContent = document.createElement('div');
    pdfContent.innerHTML = `
      <div style="font-family: 'Arial', sans-serif; color: #333;">
        <div style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
          <h1 style="margin: 5px 0; font-size: 24px;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</h1>
          <p style="margin: 5px 0; font-size: 14px;">Smart Classroom Learning System</p>
          <p style="margin: 5px 0; font-size: 12px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${dateStr} ‡πÄ‡∏ß‡∏•‡∏≤: ${timeStr}</p>
        </div>
        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
          <p style="font-size: 14px; font-weight: bold; margin: 0 0 10px 0; color: #667eea;">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</p>
          <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.week || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏™‡∏≤‡∏£‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.topic || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.unit || '-'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; width: 30%; border-bottom: 1px solid #eee;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö:</td>
              <td style="padding: 8px; border-bottom: 1px solid #eee;">${teacherConfig.teacher || '-'}</td>
            </tr>
          </table>
        </div>
         <div style="background: #f8f9fa; border: 3px solid #667eea; border-radius: 10px; padding: 20px; margin-bottom: 20px; text-align: center;">
          <p style="font-size: 16px; margin: 0 0 15px 0; color: #555;"><strong>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö</strong></p>
          <p style="font-size: 28px; color: #27ae60; font-weight: bold;">${score}/${teacherConfig.correctImages?.length || 0}</p>
        </div>
        <div style="margin-top: 300px; text-align: center;">
          <p style="margin: 0; font-size: 13px; color: #333;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠ _______________________</p>
          <p style="margin: 8px 0 0 0; font-size: 13px; color: #333;">‡∏Ñ‡∏£‡∏π‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</p>
          <p style="margin: 5px 0 0 0; font-size: 13px; color: #333;">( _______________________ )</p>
        </div>
      </div>
    `;

    html2pdf().set(opt).from(pdfContent).save();
  } catch (error) {
    console.error('Error saving PDF:', error);
  }
}

// Validate and log teacherConfig data before generating the PDF
console.log('Teacher Config:', teacherConfig);

if (!teacherConfig.topic || !teacherConfig.unit || !teacherConfig.testCount || !teacherConfig.week || !teacherConfig.teacher) {
  console.warn('Some fields in teacherConfig are missing. Please ensure all fields are provided.');
}

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Å‡∏° (‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏Å‡∏°)
function initGame() {
  if (!teacherConfig.correctImages || !teacherConfig.wrongImages) {
    alert("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏π! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
    window.location.href = 'teacher.html';
    return;
  }

  createdImages = {};
  score = 0;
  document.getElementById('score').innerText = score;

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÄ‡∏¢‡∏≠‡∏∞‡∏Å‡πá‡∏™‡∏∏‡πà‡∏° 5 ‡∏£‡∏π‡∏õ)
  const maxImages = 5;
  
  // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
  let correctImagesPool = [...teacherConfig.correctImages];
  let selectedCorrectImages = correctImagesPool.sort(() => Math.random() - 0.5).slice(0, Math.min(maxImages, correctImagesPool.length));
  
  selectedCorrectImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `correct-${index}`, true);
  });

  // ‡∏™‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏ú‡∏¥‡∏î
  let wrongImagesPool = [...teacherConfig.wrongImages];
  let selectedWrongImages = wrongImagesPool.sort(() => Math.random() - 0.5).slice(0, Math.min(maxImages, wrongImagesPool.length));
  
  selectedWrongImages.forEach((imgData, index) => {
    createDraggableImage(imgData, `wrong-${index}`, false);
  });
}

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏µ‡πà‡∏•‡∏≤‡∏Å‡πÑ‡∏î‡πâ
function createDraggableImage(imgData, imageId, isCorrect) {
  if (createdImages[imageId]) return;

  const imageDiv = document.createElement('div');
  imageDiv.classList.add('image-item');
  imageDiv.innerHTML = `<img src="${imgData}" alt="Image">`;

  const startX = 50 + Math.random() * (window.innerWidth - 200);
  const startY = 50 + Math.random() * (window.innerHeight - 350);
  const angle = Math.floor(Math.random() * 360);
  const scale = 0.8 + Math.random() * 0.6;
  imageDiv.style.left = `${startX}px`;
  imageDiv.style.top = `${startY}px`;
  imageDiv.style.transform = `rotate(${angle}deg) scale(${scale})`;

  let offsetX, offsetY;
  function dragMove(posX, posY) {
    imageDiv.style.left = `${posX}px`;
    imageDiv.style.top = `${posY}px`;
    createParticle(posX + 50, posY + 50);
    baseFreq = baseFreq >= 800 ? 200 : baseFreq + 50;
  }

  // Desktop
  imageDiv.addEventListener('mousedown', e => {
    e.preventDefault();
    offsetX = e.clientX - imageDiv.offsetLeft;
    offsetY = e.clientY - imageDiv.offsetTop;
    function onMove(e) {
      dragMove(e.clientX - offsetX, e.clientY - offsetY);
    }
    function onUp() {
      document.removeEventListener('mousemove', onMove);
      document.removeEventListener('mouseup', onUp);
      checkDrop();
    }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // Mobile
  imageDiv.addEventListener('touchstart', e => {
    const t = e.touches[0];
    offsetX = t.clientX - imageDiv.offsetLeft;
    offsetY = t.clientY - imageDiv.offsetTop;
  });
  imageDiv.addEventListener('touchmove', e => {
    const t = e.touches[0];
    dragMove(t.clientX - offsetX, t.clientY - offsetY);
  });
  imageDiv.addEventListener('touchend', e => {
    checkDrop();
  });

  // Updated the `checkDrop` function to prevent score increment for wrong images placed in the wrong zone
  function checkDrop() {
    const rect = imageDiv.getBoundingClientRect();
    const correctZone = document.getElementById('correctZone').getBoundingClientRect();
    const wrongZone = document.getElementById('wrongZone').getBoundingClientRect();

    if (rect.left + rect.width / 2 > correctZone.left && rect.left + rect.width / 2 < correctZone.right &&
        rect.top + rect.height / 2 > correctZone.top && rect.top + rect.height / 2 < correctZone.bottom) {
      if (isCorrect) {
        score += 1;
      } else {
        score -= 1;
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    } else if (rect.left + rect.width / 2 > wrongZone.left && rect.left + rect.width / 2 < wrongZone.right &&
               rect.top + rect.height / 2 > wrongZone.top && rect.top + rect.height / 2 < wrongZone.bottom) {
      if (isCorrect) {
        score -= 1;
      }
      document.getElementById('score').innerText = score;
      imageDiv.remove();
      delete createdImages[imageId];
      checkEndGame();
    }
  }

  document.body.appendChild(imageDiv);
  createdImages[imageId] = imageDiv;
}

// Function to check if the game has ended and show the popup
function checkEndGame() {
  const remainingImages = Object.keys(createdImages).length;
  if (remainingImages === 0) {
    const popup = document.getElementById('scorePopup');
    const finalScore = document.getElementById('finalScore');
    const resultMessage = document.getElementById('resultMessage');

    // Update the popup content
    finalScore.innerText = score;
    resultMessage.innerText = score > 0 ? 'üéâ ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢! ‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å üéâ' : 'üò¢ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞ üò¢';

    // Show the popup
    popup.style.display = 'block';
  }
}

// Function to close the popup
function closePopup() {
  const popup = document.getElementById('scorePopup');
  popup.style.display = 'none';
}

// Function to restart the game
function playAgain() {
  const popup = document.getElementById('scorePopup');
  popup.style.display = 'none';
  initGame();
}

// Function to toggle the share menu
function toggleShareMenu() {
  const shareMenu = document.getElementById('shareMenu');
  shareMenu.style.display = shareMenu.style.display === 'none' ? 'block' : 'none';
}

// Updated the activity modal and selection logic for direct navigation
function loadSavedActivities() {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activityList = document.getElementById('activityList');

  if (savedActivities.length === 0) {
    activityList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
    return;
  }

  activityList.innerHTML = savedActivities.map(activity => `
    <div style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px;">
      <h3 style="cursor: pointer; color: #3498db; text-decoration: underline;" onclick="selectActivity(${activity.id})">${activity.name}</h3>
      <p>‡∏™‡∏≤‡∏£‡∏∞: ${activity.topic}</p>
      <p>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${activity.config.week}</p>
    </div>
  `).join('');

  document.getElementById('activityModal').style.display = 'flex';
}

function selectActivity(activityId) {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activity = savedActivities.find(a => a.id === activityId);

  if (!activity) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
    return;
  }

  // Save the selected activity configuration and navigate to the test page
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  window.location.reload();
}

// Added functions for activity modal
// Function to load saved activities
function loadSavedActivities() {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activityList = document.getElementById('activityList');

  if (savedActivities.length === 0) {
    activityList.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</p>';
    return;
  }

  // Updated the activity list to make activity names clickable for direct play
  activityList.innerHTML = savedActivities.map(activity => `
    <div style="padding: 10px; border: 1px solid #ccc; border-radius: 5px; margin-bottom: 10px;">
      <h3 style="cursor: pointer; color: #3498db; text-decoration: underline;" onclick="selectActivity(${activity.id})">${activity.name}</h3>
      <p>‡∏™‡∏≤‡∏£‡∏∞: ${activity.topic}</p>
      <p>‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà: ${activity.config.week}</p>
    </div>
  `).join('');

  document.getElementById('activityModal').style.display = 'flex';
}

// Updated the `selectActivity` function to directly navigate to the game page
function selectActivity(activityId) {
  const savedActivities = JSON.parse(localStorage.getItem('savedActivities') || '[]');
  const activity = savedActivities.find(a => a.id === activityId);

  if (!activity) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏ô‡∏µ‡πâ');
    return;
  }

  // Save the selected activity configuration and navigate to the game page
  localStorage.setItem('emojiGameConfig', JSON.stringify(activity.config));
  window.location.href = 'gamepicture.html';
}

// Function to close the activity modal
function closeActivityModal() {
  document.getElementById('activityModal').style.display = 'none';
}

// Automatically load and start the game on page load
window.onload = function() {
  const config = localStorage.getItem('emojiGameConfig');
  if (!config) {
    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°‡∏Å‡πà‡∏≠‡∏ô');
    window.location.href = 'teacherpicture.html';
    return;
  }

  teacherConfig = JSON.parse(config);
  document.getElementById('topicName').innerText = teacherConfig.topic || '‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°';

  // Start the game automatically
  initGame();
};
</script>
<!-- Socket client (connect + heartbeat) -->
<script src="/socket.io/socket.io.js"></script>
<script src="/socket-client.js"></script>
</body>
</html>