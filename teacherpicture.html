<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teachermath Setup</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
body { 
  font-family: 'Roboto', sans-serif; 
  text-align: center; 
  margin: 0; 
  padding: 20px;
  position: relative;
  min-height: 100vh;
  overflow-x: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}
/* Responsive Design */
/* Mobile: < 768px */
@media (max-width: 767px) {
  body {
    padding: 5px !important;
  }
  h2 {
    font-size: 18px !important;
    margin: 10px 0 !important;
  }
  h3 {
    font-size: 16px !important;
    margin: 10px 0 !important;
  }
  .info-section {
    padding: 10px 15px !important;
    max-width: 95vw !important;
    width: 95vw !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .info-inputs {
    gap: 3px !important;
    flex-direction: column !important;
    width: 100% !important;
    align-items: center !important; /* center children horizontally */
  }
  .info-inputs input {
    width: 100% !important;
    font-size: 13px !important;
    padding: 7px !important;
    box-sizing: border-box !important;
    margin-bottom: 4px !important;
  }
  /* make the week input (first child) narrower and centered on mobile */
  .info-inputs input:nth-child(1) {
    width: 140px !important;
    max-width: 60% !important;
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container {
    padding: 6px !important;
    max-width: 98vw !important;
    width: 98vw !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .main-container input {
    font-size: 14px !important;
    padding: 7px !important;
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
    margin-bottom: 4px !important;
  }
  .main-container label {
    font-size: 12px !important;
  }
  .main-container > div[style*="display:flex"] {
    flex-direction: column !important;
    gap: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div {
    width: 100% !important;
    padding: 6px !important;
    box-sizing: border-box !important;
    max-width: 100% !important;
    margin: 0 2px !important;
  }
  .main-container > div[style*="display:flex"] > div input {
    max-width: 100% !important;
    width: 100% !important;
    box-sizing: border-box !important;
  }
  .neon-btn {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 35px !important;
    width: auto !important; /* don't stretch full width on mobile */
    max-width: 320px !important;
    margin: 8px auto !important; /* center horizontally */
    box-sizing: border-box !important;
  }
  .image-preview-item {
    width: 90px !important;
    height: 90px !important;
  }
}

/* Tablet: 768px - 1024px */
@media (min-width: 768px) and (max-width: 1024px) {
  .info-section {
    max-width: 90vw !important;
    width: 90vw !important;
  }
  .main-container {
    max-width: 92vw !important;
    width: 92vw !important;
  }
  .info-inputs input:nth-child(1) {
    width: 100px !important;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 150px !important;
  }
  .image-preview-item {
    width: 110px !important;
    height: 110px !important;
  }
}

/* Desktop: > 1024px */
@media (min-width: 1025px) {
  .info-section {
    max-width: 900px !important;
    width: 100% !important;
  }
  .main-container {
    max-width: 900px !important;
    width: 100% !important;
  }
  .info-inputs input:nth-child(1) {
    width: 120px !important;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 180px !important;
  }
  .image-preview-item {
    width: 120px !important;
    height: 120px !important;
  }
}

body::before {
  content: '';
  position: fixed;
  top: 0; 
  left: 0; 
  right: 0; 
  bottom: 0;
  background: linear-gradient(to bottom, #ebd09e 0%, #251f03 100%);
  z-index: -1;
}
input, button { font-size:16px; margin:5px; padding:10px; text-transform: lowercase; border-radius:15px; border:2px solid #ccc; }
textarea {
  font-size:16px; margin:5px; padding:10px; width:250px; height:120px; resize:none;
  border:2px solid #ccc; border-radius:15px;
  background: repeating-linear-gradient(
    to bottom,
    #fff,
    #fff 28px,
    #ccc 28px,
    #ccc 30px
  );
  line-height:30px;
  text-transform: lowercase; /* พิมพ์อะไรก็เป็นตัวเล็ก */
}
button { cursor:pointer; }
.image-preview-item {
  display: inline-block;
  margin: 10px;
  position: relative;
  border: 2px solid #ddd;
  border-radius: 10px;
  overflow: hidden;
  width: 120px;
  height: 120px;
  background: repeating-conic-gradient(#ddd 0% 25%, transparent 0% 50%) 50% / 20px 20px;
}
.image-preview-item img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}
.image-preview-item .remove-btn {
  position: absolute !important;
  top: 5px !important;
  right: 5px !important;
  background: none !important;
  color: #f44336 !important;
  border: 1.5px solid #f44336 !important;
  border-radius: 4px !important;
  width: 28px !important;
  height: 28px !important;
  font-size: 22px !important;
  line-height: 1 !important;
  padding: 2px 0 0 0 !important;
  box-shadow: none !important;
  font-weight: bold !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
}
.file-input-wrapper {
  position: relative;
  display: inline-block;
  margin: 10px;
}

/* Neon Button Style */
.neon-btn {
  background: linear-gradient(180deg, #f8f6f0 0%, #fffef8 45%, #fff8e8 55%, #f5f0e5 100%);
  color: #000000;
  border: 6px solid #74640a;
  border-radius: 9999px;
  box-shadow: 1px 1px 0 #000, -8px 6px #3b3305, 0 0 20px rgba(255,230,160,0.55);
  font-weight: 700;
  font-size: clamp(1rem, 2vw, 1.5rem);
  text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3), 0 -1px 0 rgba(0, 0, 0, 0.1);
  position: relative;
  padding: clamp(14px, 2.5vw, 20px) clamp(35px, 5vw, 50px);
  transform: translateZ(0);
  transition: all 0.3s ease;
  z-index: 10;
  min-height: 55px;
  display: inline-block;
  cursor: pointer;
  width: auto; /* fit to content on larger screens */
  max-width: 360px; /* prevent overly wide button */
  box-sizing: border-box;
}

.neon-btn:hover {
  transform: translateY(-2px);
  box-shadow: 2px 2px 0 #000, -10px 8px #3b3305, 0 0 25px rgba(255,230,160,0.75);
}
.file-input-label {
  background: #fff8e8;
  color: #333;
  border: 2px dashed #74640a;
  border-radius: 15px;
  font-weight: 500;
  font-size: 16px;
  padding: 12px 24px;
  margin-top: 16px;
  display: inline-block;
  cursor: pointer;
  transition: background 0.2s, border-color 0.2s;
}
.file-input-label-correct {
  background: #fffdfd !important;
  color: #4CAF50 !important;
  border: 2px solid #4CAF50 !important;
  border-radius: 12px !important;
  font-weight: 500 !important;
  font-size: 14px !important; /* reduced size */
  padding: 8px 14px !important; /* tighter padding */
  margin-top: 12px !important;
  display: inline-block !important;
  cursor: pointer !important;
  transition: background 0.2s, border-color 0.2s !important;
  min-height: 28px !important;
}
.file-input-label-wrong {
  background: #fff !important;
  color: #f44336 !important;
  border: none !important;
  border-radius: 12px !important;
  font-weight: 500 !important;
  font-size: 14px !important;
  padding: 8px 14px !important;
  margin-top: 12px !important;
  display: inline-block !important;
  cursor: pointer !important;
  transition: background 0.2s !important;
  min-height: 28px !important;
}

.file-input-label:hover {
  background: #f5f0e5;
  border-color: #bfa22a;
}
.choice-item {
  background: #f0f0f0;
  padding: 8px;
  margin: 5px 0;
  border-radius: 5px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.choice-item button {
  background: #f44336;
  color: white;
  border: none;
  padding: 5px 10px;
  border-radius: 3px;
  cursor: pointer;
  font-size: 12px;
}
.info-section {
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
  margin-bottom: 20px;
  max-width: 900px;
  width: 100%;
}
.main-container {
  max-width: 900px;
  width: 100%;
  background: rgba(255,255,255,0.9);
  padding: 20px;
  border-radius: 10px;
  border: 4px solid #74640a;
  box-shadow: 0 0 15px rgba(255,230,160,0.5), 1px 1px 0 #000, -6px 4px #3b3305;
}
.info-inputs {
  display: flex;
  gap: 5px;
  justify-content: center;
  margin: 10px 0 20px 0;
  flex-wrap: wrap;
}
.info-inputs input {
  width: 120px;
  font-size: 16px;
  padding: 10px;
  border-radius: 15px;
}
.info-inputs input:nth-child(1) {
  width: 120px;
}
.info-inputs input:nth-child(2),
.info-inputs input:nth-child(3),
.info-inputs input:nth-child(4) {
  width: 180px;
}
@media (max-width: 767px) {
  .info-inputs {
    gap: 3px;
  }
  .info-inputs input {
    width: calc(50% - 3px) !important;
    font-size: 12px !important;
    padding: 6px !important;
    box-sizing: border-box;
  }
  .neon-btn {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 35px !important;
  }
  .file-input-label {
    font-size: 12px !important;
    padding: 6px 12px !important;
    min-height: 30px !important;
    border-radius: 10px !important;
  }
}
@media (min-width: 768px) and (max-width: 1024px) {
  .info-inputs input:nth-child(1) {
    width: 100px;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 150px;
  }
}

/* Tablet/iPad simplified rules (modeled after teachermatch.html)
   - Keep it simple: a single tablet block that scales the main container and panels
   - Avoid orientation-specific branches to reduce maintenance and flicker across devices */
@media (min-width: 768px) and (max-width: 1024px) {
  .main-container {
    max-width: 92vw !important;
    width: 92vw !important;
    padding: 12px !important;
  }
  .main-container > div[style*="display:flex"] > div {
    flex: 1 1 calc(48% - 12px) !important;
    max-width: calc(48% - 12px) !important;
    padding: 10px !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] {
    gap: 12px !important;
    justify-content: center !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 72% !important;
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 88px !important;
    height: 88px !important;
    margin: 6px auto !important;
  }
}

/* iPad landscape: reduce panel width to ~40% to match user's request
   This overrides the inline flex/max-width using !important so the
   panels narrow in landscape on typical tablet viewports */
@media (min-width: 768px) and (max-width: 1024px) and (orientation: landscape) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 40% !important;
    max-width: calc(40% - 12px) !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 64% !important; /* tighten upload button wrapper to avoid overflow */
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 88px !important;
    height: 88px !important;
  }
}
@media (min-width: 1025px) {
  .info-inputs input:nth-child(1) {
    width: 120px;
  }
  .info-inputs input:nth-child(2),
  .info-inputs input:nth-child(3),
  .info-inputs input:nth-child(4) {
    width: 180px;
  }
}

@media (max-width: 767px) {
  .info-section {
    padding: 10px 15px !important;
    max-width: 91% !important;
    width: 91% !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
  .main-container {
    padding: 6px !important;
    max-width: 91% !important;
    width: 91% !important;
    border: 3px solid #74640a !important;
    box-sizing: border-box !important;
    margin: 5px auto !important;
  }
}
/* Simple final safety: keep red/green panels from exceeding the trainer/main container
   for both portrait and landscape. This is intentionally conservative and overrides
   earlier tablet rules so nothing hangs outside the container. */
@media (min-width: 768px) {
  .main-container {
    overflow: hidden; /* prevent accidental horizontal overflow */
  }
  .main-container > div[style*="display:flex"] {
    display: flex !important;
    flex-wrap: wrap !important; /* allow wrap on very small widths */
    gap: 12px !important;
    justify-content: center !important;
  }
  .main-container > div[style*="display:flex"] > div {
    box-sizing: border-box !important;
    /* auto-size panels relative to the main container: two columns that adapt */
    flex: 1 1 calc(50% - 12px) !important; /* flexible basis minus gap */
    max-width: calc(50% - 12px) !important;
    min-width: 0 !important; /* allow panels to shrink with container */
    margin: 0 !important;
    padding: 8px !important;
  }
  /* ensure inner controls scale and don't overflow the panel */
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 90% !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-label,
  .main-container > div[style*="display:flex"] > div .file-input-label-correct,
  .main-container > div[style*="display:flex"] > div .file-input-label-wrong {
    white-space: normal !important;
    overflow-wrap: break-word !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    max-width: 120px !important; /* scale but cap size */
    width: 100% !important;
    height: auto !important;
  }
}
/* iPad Pro specific tweaks (11" and 12.9") — make portrait and landscape use the same panel sizing */
/* 11" iPad Pro typical CSS viewport: ~834 x 1194 */
@media (min-width: 820px) and (max-width: 1194px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important;
    max-width: 28% !important;
    padding: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 86% !important;
    margin: 8px auto !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 88px !important;
    height: 88px !important;
  }
}

/* 12.9" iPad Pro typical CSS viewport: ~1024 x 1366 */
@media (min-width: 1024px) and (max-width: 1366px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 28% !important;
    max-width: 28% !important;
    padding: 6px !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 86% !important;
    margin: 8px auto !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 96px !important;
    height: 96px !important;
  }
}

/* iPad Pro 13-inch adjustments based on teachermatch.html */
@media (min-width: 1366px) and (max-width: 1024px) {

  .main-container {
    max-width: 85% !important;
    width: 85% !important;
    padding: 16px !important; /* Adjust padding to ensure proper spacing */
    border: 3px solid #74640a !important;
  }
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 30% !important;
    max-width: calc(30% - 12px) !important;
    box-sizing: border-box !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 68% !important;
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 96px !important;
    height: 96px !important;
    margin: 6px auto !important;
  }
}

@media (max-width: 767px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 1 1 100% !important;
    max-width: 100% !important;
    padding: 6px !important;
  }
}
/* Portrait-specific: ลดความกว้างกรอบภายใน (กรอบเทา/ไฟล์อินพุต) ให้แคบลงเมื่อเครื่องอยู่ในแนวตั้ง */
@media (orientation: portrait) {
  .main-container {
    max-width: 86vw !important;
    width: 86vw !important;
    padding: 10px !important;
  }
  /* ใช้ auto-sizing เหมือน landscape: panel sizing controlled by tablet block */
}

/* Ensure tablet panels use 30% on common tablet and iPad viewports
   Placing this at the end of the stylesheet guarantees it overrides
   earlier, more generic rules (cascade and specificity). */
@media (min-width: 768px) and (max-width: 1366px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 30% !important;
    max-width: calc(30% - 12px) !important;
    box-sizing: border-box !important;
    padding: 8px !important;
  }
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 86% !important;
    margin: 6px auto !important;
    display: block !important;
  }
  .main-container > div[style*="display:flex"] > div .image-preview-item {
    width: 88px !important;
    height: 88px !important;
  }
}

/* Increase red/green panel width by 50% for iPad */
@media (min-width: 768px) and (max-width: 1366px) {
  .main-container > div[style*="display:flex"] > div {
    flex: 0 0 45% !important; /* Increase panel width to 45% */
    max-width: calc(45% - 12px) !important;
    box-sizing: border-box !important;
  }
}

/* Adjust white box alignment inside red/green panels for landscape */
@media (min-width: 768px) and (max-width: 1366px) and (orientation: landscape) {
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    margin: 0 auto !important; /* Center the white box */
  }
}

/* Reduce white box width inside red/green panels for portrait */
@media (min-width: 765px) and (max-width: 1360px) and (orientation: portrait) {
  .main-container > div[style*="display:flex"] > div .file-input-wrapper {
    max-width: 50% !important; /* Reduce width to 50% */
    margin-left: 20px !important; /* Maintain left shift of 20px */
    box-sizing: border-box !important; /* Ensure proper sizing */
  }
}
.small-activity-btn {
  font-size:13px !important;
  padding:7px 18px !important;
  min-height:32px !important;
  max-width:180px !important;
  border-width:3px !important;
  border-radius:18px !important;
  box-shadow:1px 1px 0 #000,-4px 3px #3b3305,0 0 10px rgba(255,230,160,0.35) !important;
}
.large-activity-btn {
  font-size:18px !important;
  padding:16px 40px !important;
  min-height:48px !important;
  max-width:320px !important;
  border-width:6px !important;
  border-radius:32px !important;
  box-shadow:2px 2px 0 #000,-8px 6px #3b3305,0 0 20px rgba(255,230,160,0.55) !important;
}

#activityListModal button[onclick*="closeActivityListModal"] {
  background: none !important;
  color: #222 !important;
  border: none !important;
  border-radius: 0 !important;
  width: auto !important;
  height: auto !important;
  font-size: 32px !important;
  line-height: 1 !important;
  padding: 0 !important;
  box-shadow: none !important;
  font-weight: bold !important;
  position: absolute !important;
  top: 12px !important;
  right: 12px !important;
}
</style>
</head>
<body>

<div style="width:100%;display:flex;justify-content:flex-start;align-items:center;margin-bottom:8px;">
  <button class="neon-btn large-activity-btn" id="openActivityListBtn" style="margin-left:780px;">เลือกกิจกรรมที่บันทึกไว้</button>
</div>
<div class="info-section">
  <h3>กรอกข้อมูลกิจกรรม</h3>
  <div class="info-inputs">
    <input id="weekInput" placeholder="สัปดาห์ที่">
    <input id="topicInput" placeholder="สาระการเรียนรู้">
    <input id="unitInput" placeholder="หน่วยการเรียนรู้">
    <input id="teacherInput" placeholder="ครูผู้รับผิดชอบ">
  </div>
</div>

<div class="main-container">

  <!-- ลบ section โจทย์เลขและคำตอบคณิตศาสตร์ออก เหลือเฉพาะกรอบอัพโหลดรูปภาพ -->
  <h3 style="margin-top:40px;">เพิ่มรูปภาพ</h3>
  <input id="mainTopicInput" placeholder="หัวข้อกิจกรรม/หมวดหมู่" style="max-width:500px; font-size:18px; padding:12px; border-radius:15px; margin-bottom:20px; background:#fff; border:2px solid #ccc; box-shadow:none; color:#333;"><br>
  <div style="display:flex; gap:5px; justify-content:center; margin-top:20px;">
    <div style="flex:1 1 calc(50% - 12px); max-width:calc(50% - 12px); background:rgba(76, 175, 80, 0.1); padding:12px; border-radius:10px; border:2px solid #4CAF50;">
      <label style="color:#4CAF50; font-weight:bold;">รูปที่ถูกต้อง ✅</label><br>
      <div class="file-input-wrapper" style="margin-top:10px;">
        <label class="file-input-label file-input-label-correct">เลือกภาพ
          <input type="file" id="correctImageInput" accept="image/*" onchange="handleImageUpload(event, 'correct')">
        </label>
      </div>
      <div id="correctImagesList" style="margin-top:10px;"></div>
    </div>
    <div style="flex:1 1 calc(50% - 12px); max-width:calc(50% - 12px); background:rgba(244, 67, 54, 0.1); padding:12px; border-radius:10px; border:2px solid #f44336;">
      <label style="color:#f44336; font-weight:bold;">รูปที่ผิด ❌</label><br>
      <div class="file-input-wrapper" style="margin-top:10px;">
        <label class="file-input-label file-input-label-wrong">เลือกภาพ
          <input type="file" id="wrongImageInput" accept="image/*" onchange="handleImageUpload(event, 'wrong')">
        </label>
      </div>
      <div id="wrongImagesList" style="margin-top:10px;"></div>
    </div>
  </div>
</div>
  <button class="neon-btn" id="saveActivityBtn" style="background:#e0eaff;">บันทึกกิจกรรม</button>
  <button class="neon-btn" onclick="saveConfig()">เริ่มกิจกรรม</button>

  <!-- Popup Modal สำหรับรายการกิจกรรม -->
  <div id="activityListModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fffef8;border-radius:18px;max-width:420px;width:90vw;padding:28px 18px;box-shadow:0 8px 32px rgba(0,0,0,0.18);border:2px solid #74640a;position:relative;">
      <h3 style="margin-top:0;margin-bottom:18px;color:#74640a;text-align:center;">เลือกกิจกรรมที่บันทึกไว้</h3>
      <ul id="activityList" style="padding-left:0;margin:0;list-style:none;"></ul>
      <button onclick="closeActivityListModal()" style="position:absolute;top:12px;right:12px;background:#f44336;color:#fff;border:none;border-radius:50%;width:32px;height:32px;font-size:20px;cursor:pointer;">×</button>
    </div>
  </div>
  

<script>
let correctImages = [];
let wrongImages = [];
let editingActivityIdx = null;

// ฟังก์ชันจัดการรูปภาพที่อัปโหลด
function handleImageUpload(event, type) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      // Auto crop to square
      const croppedImageData = autoCropToSquare(img);
      
      // เพิ่มรูปเข้าอาร์เรย์
      if (type === 'correct') {
        correctImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('correct');
      } else {
        wrongImages.push(croppedImageData);
        event.target.value = ''; // Clear input
        renderImages('wrong');
      }
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// ฟังก์ชันปรับขนาดและตัดพื้นหลังอัตโนมัติ
function autoCropToSquare(img) {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  
  // กำหนดขนาดสูงสุด
  const maxSize = 300;
  let width = img.width;
  let height = img.height;
  
  // ปรับขนาดถ้ารูปใหญ่เกินไป โดยรักษาสัดส่วน
  if (width > maxSize || height > maxSize) {
    if (width > height) {
      height = (height / width) * maxSize;
      width = maxSize;
    } else {
      width = (width / height) * maxSize;
      height = maxSize;
    }
  }
  
  canvas.width = width;
  canvas.height = height;
  
  // วาดรูปลงบน canvas
  ctx.drawImage(img, 0, 0, width, height);
  
  // ตัดพื้นหลัง
  const imageData = ctx.getImageData(0, 0, width, height);
  const data = imageData.data;
  
  // หาสีพื้นหลัง (ใช้สีมุม 4 มุม)
  const corners = [
    [0, 0], // มุมซ้ายบน
    [width - 1, 0], // มุมขวาบน
    [0, height - 1], // มุมซ้ายล่าง
    [width - 1, height - 1] // มุมขวาล่าง
  ];
  
  let bgColor = null;
  for (let corner of corners) {
    const x = corner[0];
    const y = corner[1];
    const index = (y * width + x) * 4;
    const r = data[index];
    const g = data[index + 1];
    const b = data[index + 2];
    
    if (r > 200 && g > 200 && b > 200) { // สีขาวหรือใกล้เคียง
      bgColor = { r, g, b };
      break;
    }
  }
  
  // ตัดพื้นหลังออก (ถ้าเจอสีพื้นหลัง)
  if (bgColor) {
    const threshold = 40; // ค่าความต่างของสี
    for (let i = 0; i < data.length; i += 4) {
      const r = data[i];
      const g = data[i + 1];
      const b = data[i + 2];
      
      // ถ้าสีใกล้เคียงกับพื้นหลัง ให้โปร่งใส
      if (Math.abs(r - bgColor.r) < threshold && 
          Math.abs(g - bgColor.g) < threshold && 
          Math.abs(b - bgColor.b) < threshold) {
        data[i + 3] = 0; // ทำให้โปร่งใส
      }
    }
    
    ctx.putImageData(imageData, 0, 0);
  }
  
  // แปลงเป็น base64 (ใช้ PNG เพื่อรักษาความโปร่งใส)
  return canvas.toDataURL('image/png', 0.9);
}

// ฟังก์ชันลบรูปภาพ
function removeImage(type, index) {
  if (type === 'correct') {
    correctImages.splice(index, 1);
    renderImages('correct');
  } else {
    wrongImages.splice(index, 1);
    renderImages('wrong');
  }
}

// ฟังก์ชันแสดงรายการรูปภาพ
function renderImages(type) {
  const listId = type === 'correct' ? 'correctImagesList' : 'wrongImagesList';
  const images = type === 'correct' ? correctImages : wrongImages;
  const list = document.getElementById(listId);
  
  list.innerHTML = images.map((imgData, i) => `
    <div class="image-preview-item">
      <img src="${imgData}" alt="Image ${i+1}">
      <button class="remove-btn" onclick="removeImage('${type}', ${i})">×</button>
    </div>
  `).join('');
}

// โหลด config เก่าถ้ามี
const savedConfig = JSON.parse(localStorage.getItem('emojiGameConfig')||'{}');
if(savedConfig.topic) document.getElementById('topicInput').value = savedConfig.topic;
if(savedConfig.correctImages) correctImages = savedConfig.correctImages;
if(savedConfig.wrongImages) wrongImages = savedConfig.wrongImages;
renderImages('correct');
renderImages('wrong');

function saveConfig(){
  const week = document.getElementById('weekInput')?.value.trim();
  const topic = document.getElementById('topicInput')?.value.trim();
  const unit = document.getElementById('unitInput')?.value.trim();
  const teacher = document.getElementById('teacherInput')?.value.trim();
  const mainTopic = document.getElementById('mainTopicInput')?.value.trim();
  // dateInput may not exist, so skip

  if(!week){ alert("กรุณากรอกสัปดาห์ที่"); return; }
  if(!topic){ alert("กรุณากรอกสาระการเรียนรู้"); return; }
  if(!unit){ alert("กรุณากรอกหน่วยการเรียนรู้"); return; }
  if(!teacher){ alert("กรุณากรอกชื่อครูผู้รับผิดชอบ"); return; }
  if(!mainTopic){ alert("กรุณากรอกหัวข้อกิจกรรม/หมวดหมู่"); return; }
  if(correctImages.length === 0){ alert("กรุณาเพิ่มรูปที่ถูกต้องอย่างน้อย 1 รูป"); return; }
  if(wrongImages.length === 0){ alert("กรุณาเพิ่มรูปที่ผิดอย่างน้อย 1 รูป"); return; }

  // Save config
  const config = {
    week: week,
    topic: topic,
    unit: unit,
    teacher: teacher,
    mainTopic: mainTopic,
    correctImages: correctImages,
    wrongImages: wrongImages
  };
  localStorage.setItem('emojiGameConfig', JSON.stringify(config));

  window.location.href='gamepicture.html';
}

// เพิ่มฟีเจอร์บันทึกกิจกรรมสำหรับครู (ใช้งานซ้ำ)
document.getElementById('saveActivityBtn').onclick = function() {
  const week = document.getElementById('weekInput')?.value.trim();
  const topic = document.getElementById('topicInput')?.value.trim();
  const unit = document.getElementById('unitInput')?.value.trim();
  const teacher = document.getElementById('teacherInput')?.value.trim();
  const mainTopic = document.getElementById('mainTopicInput')?.value.trim();
  let items = JSON.parse(localStorage.getItem('teacherActivityList') || '[]');
  if (editingActivityIdx !== null) {
    items[editingActivityIdx] = {
      week, topic, unit, teacher, mainTopic,
      correctImages, wrongImages,
      date: new Date().toISOString().split('T')[0],
      time: new Date().toLocaleTimeString()
    };
    localStorage.setItem('teacherActivityList', JSON.stringify(items));
    alert('อัปเดตกิจกรรมสำเร็จ!');
    editingActivityIdx = null;
    document.getElementById('saveActivityBtn').textContent = 'บันทึกกิจกรรม';
    document.getElementById('saveActivityBtn').style.background = '#4CAF50'; // เขียว
    document.getElementById('saveActivityBtn').style.color = '#fff';
  } else {
    items.push({
      week, topic, unit, teacher, mainTopic,
      correctImages, wrongImages,
      date: new Date().toISOString().split('T')[0],
      time: new Date().toLocaleTimeString()
    });
    localStorage.setItem('teacherActivityList', JSON.stringify(items));
    alert('บันทึกกิจกรรมสำเร็จ!');
    document.getElementById('saveActivityBtn').style.background = '#4CAF50'; // เขียว
    document.getElementById('saveActivityBtn').style.color = '#fff';
  }
}

// เพิ่มฟังก์ชันแสดงรายการกิจกรรมที่บันทึกไว้
function renderActivityList() {
  const list = document.getElementById('activityList');
  const items = JSON.parse(localStorage.getItem('teacherActivityList') || '[]');
  if (!list) return;
  if (items.length === 0) {
    list.innerHTML = '<li style="color:#aaa;text-align:center;">ยังไม่มีการบันทึกกิจกรรม</li>';
    return;
  }
  list.innerHTML = items.map((item, idx) => `
    <li style="margin-bottom:14px;display:flex;align-items:center;gap:10px;background:#fffbe6;border-radius:10px;padding:10px 12px;box-shadow:0 2px 8px rgba(255,230,160,0.08);">
      <button onclick="playActivity(${idx})" style="flex:1;text-align:left;background:none;border:none;color:#333;font-size:16px;cursor:pointer;padding:0;">
        <strong>กิจกรรมที่ ${idx+1}</strong>: สัปดาห์: ${item.week || '-'}, สาระ: ${item.topic || '-'}, หน่วย: ${item.unit || '-'}, ครู: ${item.teacher || '-'}, หมวดหมู่: ${item.mainTopic || '-'}
        <span style='color:#888;font-size:12px;'> (${item.date || ''} ${item.time || ''})</span>
      </button>
      <button onclick="editActivity(${idx})" style="background:#2196f3;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:14px;margin-right:4px;">แก้ไข</button>
      <button onclick="deleteActivity(${idx})" style="background:#f44336;color:#fff;border:none;border-radius:6px;padding:4px 10px;cursor:pointer;font-size:14px;">ลบ</button>
    </li>
  `).join('');
}
function openActivityListModal() {
  document.getElementById('activityListModal').style.display = 'flex';
  renderActivityList();
}
function closeActivityListModal() {
  document.getElementById('activityListModal').style.display = 'none';
}
// ฟังก์ชันเล่นกิจกรรมที่เลือก
function playActivity(idx) {
  const items = JSON.parse(localStorage.getItem('teacherActivityList') || '[]');
  if (!items[idx]) return;
  localStorage.setItem('emojiGameConfig', JSON.stringify(items[idx]));
  window.location.href = 'gamepicture.html';
}
// ฟังก์ชันลบกิจกรรม
function deleteActivity(idx) {
  let items = JSON.parse(localStorage.getItem('teacherActivityList') || '[]');
  if (!items[idx]) return;
  if (!confirm('ต้องการลบกิจกรรมนี้ใช่หรือไม่?')) return;
  items.splice(idx, 1);
  localStorage.setItem('teacherActivityList', JSON.stringify(items));
  renderActivityList();
}
// ฟังก์ชันแก้ไขกิจกรรม
function editActivity(idx) {
  const items = JSON.parse(localStorage.getItem('teacherActivityList') || '[]');
  if (!items[idx]) return;
  const item = items[idx];
  document.getElementById('weekInput').value = item.week || '';
  document.getElementById('topicInput').value = item.topic || '';
  document.getElementById('unitInput').value = item.unit || '';
  document.getElementById('teacherInput').value = item.teacher || '';
  document.getElementById('mainTopicInput').value = item.mainTopic || '';
  correctImages = item.correctImages || [];
  wrongImages = item.wrongImages || [];
  renderImages('correct');
  renderImages('wrong');
  editingActivityIdx = idx;
  closeActivityListModal();
  document.getElementById('saveActivityBtn').textContent = 'อัปเดตกิจกรรม';
  document.getElementById('saveActivityBtn').style.background = '#FFD600'; // เหลือง
  document.getElementById('saveActivityBtn').style.color = '#333';
}

// เรียกแสดงรายการกิจกรรมเมื่อเปิด modal
if(document.getElementById('openActivityListBtn')){
  document.getElementById('openActivityListBtn').addEventListener('click', openActivityListModal);
}
// อัปเดตรายการเมื่อบันทึกกิจกรรมใหม่
if(document.getElementById('saveActivityBtn')){
  document.getElementById('saveActivityBtn').addEventListener('click', renderActivityList);
}

document.getElementById('activityListModal').addEventListener('mousedown', function(e) {
  if (e.target === this) {
    closeActivityListModal();
  }
});
</script>

</body>
</html>
